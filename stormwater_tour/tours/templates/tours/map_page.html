{% extends "tours/base.html" %}
{% load staticfiles %}

{% block title %}Map Page{% endblock %}

{% block custom_css %}
<link href="{% static "tours/css/map_page.css" %}" rel="stylesheet">
{% endblock %}
      
    {% block container %}  
      <div class="panel panel-default" id="directions_panel">
        <div class = "panel-heading" id="directions_title"><strong>Directions</strong></div>
        <div class="panel-body">
        <div class="visible-xs-block">
          <span class="directions-body">{{ next_site.simple_directions|safe|force_escape }}<br></span>
            {% if sites %}
              <a href="{% url 'tours:site' tour_slug next_site.site_slug %}" class="btn btn-primary btn-block directions-link">Arrived at {{ tour.site_nickname }}</a>
            {% endif %}
        </div>
        <div class="hidden-xs">
          <table style="width:100%">
            <tr>
              <td><span class="directions-body">{{ next_site.simple_directions|safe|force_escape }}</span></td>
              {% if sites %}
                <td style="padding-left: 5px"><a href="{% url 'tours:site' tour_slug next_site.site_slug %}" class="btn btn-primary pull-right directions-link">Arrived at {{ tour.site_nickname }}</a></td>
              {% endif %}
            </tr>
            </table>
          </div>
        </div>
      </div>
      <div>

        <div id="map"></div>

        <div class="legend btn-group btn-group-justified hidden-xs">
          <div class="btn-group">
            <a href="#" type="button" class="btn btn-default disabled">Current: <img src="{% if map_page.current_site_marker %}{{ map_page.current_site_marker.url }}{% else %}http://maps.google.com/mapfiles/ms/icons/yellow-dot.png{% endif %}">
            </a>
          </div>
          <div class="btn-group">
            <a href="#" type="button" class="btn btn-default disabled">
              Next: <img src="{% if map_page.next_site_marker %}{{ map_page.next_site_marker.url }}{% else %}http://maps.google.com/mapfiles/ms/icons/green-dot.png{% endif %}">
            </a>
          </div>
          <div class="btn-group">
            <a href="#" type="button" class="btn btn-default disabled">
              Not Visited: <img src="{% if map_page.site_unvisited_marker %}{{ map_page.site_unvisited_marker.url }}{% else %}http://maps.google.com/mapfiles/ms/icons/red-dot.png{% endif %}">
            </a>
          </div>
          <div class="btn-group">
            <a href="#" type="button" class="btn btn-default disabled">
              Visited: <img src="{% if map_page.site_visited_marker %}{{ map_page.site_visited_marker.url }}{% else %}http://maps.google.com/mapfiles/ms/icons/blue-dot.png{% endif %}">
            </a>
          </div>
        </div>

        <div class="legend-xs-topbtn-group btn-group-justified visible-xs-block">
          <div class="btn-group">
            <button type="button" class="btn btn-default disabled">
              Current: <img src="{% if map_page.current_site_marker %}{{ map_page.current_site_marker.url }}{% else %}http://maps.google.com/mapfiles/ms/icons/yellow-dot.png{% endif %}">
            </button>
          </div>
          <div class="btn-group">
            <button type="button" class="btn btn-default disabled">
              Next: <img src="{% if map_page.next_site_marker %}{{ map_page.next_site_marker.url }}{% else %}http://maps.google.com/mapfiles/ms/icons/green-dot.png{% endif %}">
            </button>
          </div>
        </div>
        <div class="legend-xs-bot btn-group btn-group-justified visible-xs-block">
          <div class="btn-group">
            <button type="button" class="btn btn-default disabled">
              Not Visited: <img src="{% if map_page.site_unvisited_marker %}{{ map_page.site_unvisited_marker.url }}{% else %}http://maps.google.com/mapfiles/ms/icons/red-dot.png{% endif %}">
            </button>
          </div>
          <div class="btn-group">
            <button type="button" class="btn btn-default disabled">
              Visited: <img src="{% if map_page.site_visited_marker %}{{ map_page.site_visited_marker.url }}{% else %}http://maps.google.com/mapfiles/ms/icons/blue-dot.png{% endif %}">
            </button>
          </div>
        </div>

      </div>
      {% for site in sites %} 
        <!-- Site Modal -->
          <div class="modal fade" id="{{ site.id }}_Modal">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="{{ site.id }}_ModalLabel">Confirm Site Choice</h4>
              </div>
              <div class="modal-body">
                Are you sure you want to choose {{ site.title }}?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button name="button-close" class="btn btn-primary" data-dismiss="modal" onclick="confirmSite_{{ site.id }}()">Give me Directions!</button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}

      <!-- Feedback Modal -->
      <div class="modal fade" id="Feedback_Modal">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title" id="Feedback_ModalLabel">{% if sites_visited.count == sites.count %}Thank you for completing the tour!{% else %}We want your feedback!{% endif %}</h4>
            </div>
            <div class="modal-body">
              Please take a moment to leave us your opinions of the tour!
            </div>
            <div class="modal-footer">
              <div class="visible-xs-block">
                <a href="{% url 'tours:feedback' tour.tour_slug %}" class="btn btn-primary btn-block">Leave feedback</a>
                {% if sites_visited.count != sites.count %}<button type="button" class="btn btn-default btn-block" data-dismiss="modal">Remind me later</button>{% endif %}
                <button type="button" class="btn btn-default btn-block feedback-remove">No thanks</button>
              </div>
              <div class="hidden-xs">
                <button type="button" class="btn btn-default feedback-remove">No thanks</button>
                {% if sites_visited.count != sites.count %}<button type="button" class="btn btn-default" data-dismiss="modal">Remind me later</button>{% endif %}
                <a href="{% url 'tours:feedback' tour.tour_slug %}" class="btn btn-primary">Leave feedback</a>
              </div>
            </div>
          </div>
        </div>
      </div>


      {% if sites %}
        <h3>Sites to Tour</h3>
        <a href="#" class="site-btn btn next disabled" id="btn_next_{{ next_site.id }}" style="display: block">{{ next_site.title }}</a>      
        {% for site in sites %}
          {% if site not in sites_visited and site != next_site %}<a class="site-btn btn unvisited" type="button" data-toggle="modal" data-target="#{{ site.id }}_Modal" id="btn_{{ site.id }}" style="display: block">{{ site.title }}</a>
          {% elif site == next_site %}<a class="site-btn btn unvisited" type="button" data-toggle="modal" data-target="#{{ site.id }}_Modal" id="btn_{{ site.id }}" style="display: none">{{ site.title }}</a>
          {% endif %}
        {% endfor %}
        {% for site in sites_visited %}
          {% if site != current_site %}<a class="site-btn btn visited" type="button" data-toggle="modal" data-target="#{{ site.id }}_Modal" id="btn_{{ site.id }}" style="display: block">{{ site.title }}</a>
          {% endif %}
        {% endfor %}
        {% if current_site %}<a class="site-btn btn current" type="button" data-toggle="modal" data-target="#{{ current_site.id }}_Modal" id="btn_{{ current_site.id }}" style="display: block">{{ current_site.title }}</a>
        {% endif %}
      {% endif %}
    {% endblock %}
  {% block custom_js %}
    <!-- Map JavaScript -->
    <script type="text/javascript" 
            src="https://maps.googleapis.com/maps/api/js?key={{ dev_map_key }}"></script>
    <script type="text/javascript">
      var directionsService = new google.maps.DirectionsService();
      var directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers: true});

      {% for site in sites %}
        var location_{{ site.id }} = new google.maps.LatLng({{ site.location.latitude }}, {{ site.location.longitude }});
        {% if forloop.first %}
          {% if current_site %}
            var start = location_{{ current_site.id }};
          {% else %}
            var start = location_{{ next_site.id }};
          {% endif %}
        {% endif %}
      {% endfor %}

      var end;
      var map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: {{ map_page.map_center.latitude }}, lng: {{ map_page.map_center.longitude }}},
        zoom: {{ map_page.map_default_zoom }},
        disableDefaultUI: true,
        mapTypeControl: true,
        mapTypeControlOptions: {
          style: google.maps.MapTypeControlStyle.DEFAULT,
          position: google.maps.ControlPosition.TOP_LEFT,
          mapTypeIds: [
            google.maps.MapTypeId.ROADMAP,
            google.maps.MapTypeId.SATELLITE
          ]
        },
      });
      google.maps.event.addDomListener(window, 'resize');
      google.maps.event.addDomListener(window, 'load');

      // Directions
      directionsDisplay.setMap(map);
      {% if sites %}
        {% if current_site %}
          start = location_{{ current_site.id }};
        {% else %}
          start = location_{{ next_site.id }};
        {% endif %}
      {% endif %}
      function mapRoute(){
        directionsService.route({
          origin: start,
          destination: end,
          travelMode: google.maps.DirectionsTravelMode.{{ tour.travel_method }}
        }, function(response, status) {
          if (status == google.maps.DirectionsStatus.OK) {
            directionsDisplay.setDirections(response);
          }
          directionsDisplay.setMap(map);
        });
      }

      // Restrict Zoom
      var opt = { minZoom: {{ map_page.map_min_zoom }}, maxZoom: {{map_page.map_max_zoom }}};
      map.setOptions(opt);

      var current_site_pin = {% if map_page.current_site_marker %}
              '{{ map_page.current_site_marker.url }}';
            {% else %}
              'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png';
            {% endif %}

      var next_site_pin = {% if map_page.next_site_marker %}
              '{{ map_page.next_site_marker.url }}';
            {% else %}
              'http://maps.google.com/mapfiles/ms/icons/green-dot.png';
            {% endif %}

      var site_visited_pin = {% if map_page.site_visited_marker %}
              '{{ map_page.site_visited_marker.url }}';
            {% else %}
              'http://maps.google.com/mapfiles/ms/icons/blue-dot.png';
            {% endif %}

      var site_unvisited_pin = {% if map_page.site_unvisited_marker %}
              '{{ map_page.site_unvisited_marker.url }}';
            {% else %}
              'http://maps.google.com/mapfiles/ms/icons/red-dot.png';
            {% endif %}

      {% for site in sites %}
        // Markers and info window code
        var contentString_{{ site.id }} = 
          '<div class="modal-header">'+
            '<h4 class="modal-title" id="myModalLabel">{{ site.title }}</h4>'+
          '</div>'+
          '<div class="modal-footer">'+
            '<div class=visible-xs-block>'+
              '<button name="button-close" class="btn btn-primary btn-block" onclick="confirmSite_{{ site.id }}()">Give me Directions!</button>'+
              '<button name="button-close" class="btn btn-default btn-block" onclick="closeInfoWindow_{{ site.id }}()">Cancel</button>'+
            '</div>'+
            '<div class=hidden-xs>'+
              '<button name="button-close" class="btn btn-default" onclick="closeInfoWindow_{{ site.id }}()">Cancel</button>'+
              '<button name="button-close" class="btn btn-primary" onclick="confirmSite_{{ site.id }}()">Give me Directions!</button>'+
            '</div>'+
          '</div>';

        var infowindow_{{ site.id }} = new google.maps.InfoWindow({
          content: contentString_{{ site.id }}
        });

          //Closes the infowindow
        function closeInfoWindow_{{ site.id }}(){
          parent.infowindow_{{ site.id }}.close();
        }
        // Confirm Site
        var nextsitemark = new google.maps.Marker({title: 'next'});
        var nextsitemark_string = 'next';
        function confirmSite_{{ site.id }}(){
          return new Promise(function (fulfill, reject){
            parent.infowindow_{{ site.id }}.close();

            marker_icon = site_unvisited_pin;

            if(nextsitemark.getTitle() != 'next'){
              {% if current_site %}
              if(nextsitemark == marker_{{ current_site.id }}){
                marker_icon = current_site_pin;
              } else {% endif %}if (nextsitemark == marker_{{ site.id }}){
                marker_icon = next_site_pin;
              }
              {% for visited in sites_visited %}{% if visited.id = site.id %}
              if('{{ site.id }}' == nextsitemark_id){
                marker_icon = site_visited_pin;
              }
              {% endif %}{% endfor %}
              nextsitemark.setIcon(marker_icon);
              nextsitemark = marker_{{ site.id }};
              nextsitemark_id = '{{ site.id }}';
            } else {
              if ('{{ site.id }}' == '{{ next_site.id }}'){
                marker_icon = next_site_pin;
              }
              marker_{{ next_site.id }}.setIcon(marker_icon);
              nextsitemark = marker_{{ site.id }};
              nextsitemark_string = '{{ site.id }}';
            }
            marker_icon = next_site_pin;
            marker_{{ site.id }}.setIcon(marker_icon);
            var directions_body = document.getElementsByClassName("directions-body");
            for (x = 0; x < directions_body.length; x++){
              directions_body[x].textContent="{{ site.simple_directions|safe }}";
            }
            var site_link = document.getElementsByClassName("directions-link");
            for (x = 0; x < site_link.length; x++){
              site_link[x].href="{% url 'tours:site' tour_slug site.site_slug %}";
            }

            document.getElementById("btn_next_{{ next_site.id }}").textContent = document.getElementById("btn_{{ site.id }}").textContent;
            {% for site2 in sites %}
                document.getElementById("btn_{{ site2.id }}").style="display: block";
            {% endfor %}
            document.getElementById("btn_{{ site.id }}").style="display: none";
            end = location_{{ site.id }};
            if( "{{ current_site.id }}" != ""){
              mapRoute();
            }
            window.scrollTo(0, 0);
          });
        }

        // Sets pin to unvisited pin if site has not been visited
        marker_icon = site_unvisited_pin;
        // Sets pin to visited pin if site has been visited
        {% for visited in sites_visited %}{% if visited.id == site.id %}
            marker_icon = site_visited_pin;
          {% endif %}{% endfor %}
        

          // Sets pin to current site pin if this is the current site
        if ('{{ site.id }}' == '{{ current_site.id }}'){
            marker_icon = current_site_pin;
        } 
        // Sets pin to next site pin if this is the next site
        else if ('{{ site.id }}' == '{{ next_site.id }}'){
            marker_icon = next_site_pin;
            end = location_{{ site.id }};
            {% if current_site %}
              mapRoute();
            {% endif %}
        } 
        
        var marker_{{ site.id }} = new google.maps.Marker({
          position: {lat: {{ site.location.latitude }}, lng: {{ site.location.longitude }}},
          map: map,
          icon: marker_icon,
        });
        var infowindow = null;
        marker_{{ site.id }}.addListener('click', function() {
          if(infowindow){
            infowindow.close();
          }
          infowindow_{{ site.id }}.open(map, marker_{{ site.id }});
          window.scrollTo(0, 0);
          infowindow = infowindow_{{ site.id }};
        });
      {% endfor %}

      {% for landmark in landmark_markers %}
        var landmark_{{ landmark.id }} = new google.maps.Marker({
          position: {lat: {{ landmark.location.latitude }}, lng: {{ landmark.location.longitude }}},
          map: map,
          visible: false,
          icon: '{{ landmark.file_location.url }}',
        });
      {% endfor %}

      google.maps.event.addListener(map, 'zoom_changed', function(){
        var zoom = map.getZoom();

        {% for landmark in landmark_markers %}
          landmark_{{ landmark.id }}.setVisible(zoom == {{ map_page.map_max_zoom }});
        {% endfor %}
      });

      // Contain Map within bounds
      var allowedBounds = new google.maps.LatLngBounds(
        new google.maps.LatLng({{ map_page.map_lower_bound.latitude }}, {{ map_page.map_lower_bound.longitude }}),
        new google.maps.LatLng({{ map_page.map_upper_bound.latitude }}, {{ map_page.map_upper_bound.longitude }}) 
      );

      var lastValidCenter = map.getCenter();

      google.maps.event.addListener(map, 'center_changed', function() {
        if (allowedBounds.contains(map.getCenter())) {
          // still within valid bounds, so save the last valid position
          lastValidCenter = map.getCenter();
          return; 
        }

        // not valid anymore => return to last valid position
        map.panTo(lastValidCenter);
      });

      // Loads feedback modal if number or sites visited exceeds amount specified.
      {% if sites_visited.count == feedback.feedback_request_checkpoint or sites_visited.count == sites.count %}
        {% if not feedback_submitted and not no_feedback_prompt %}
          $(window).load(function(){
            $('#Feedback_Modal').modal('show');
          });
        {% endif %}
      {% endif %} 

      $("#Feedback_Modal").on("click", ".feedback-remove", function(){
        $.get("{% url 'tours:feedback' tour.tour_slug %}", function(){
          $('#Feedback_Modal').modal('hide');
        });
      });

      var panoramaOptions = {
        disableDefaultUI: true
      };

      var styles = [
        {
          "featureType": "poi.business",
          "stylers": [
            { "visibility": "off" }
          ]
        },{
          "featureType": "poi.place_of_worship",
          "stylers": [
            { "visibility": "off" }
          ]
        },{
          "featureType": "poi.school",
          "elementType": "labels.text",
          "stylers": [
            { "visibility": "off" }
          ]
        },{
          "featureType": "poi.school",
          "elementType": "labels.icon",
          "stylers": [
            { "visibility": "off" }
          ]
        },{
          "featureType": "poi.sports_complex",
          "stylers": [
            { "visibility": "off" }
          ]
        },{
          "featureType": "transit",
          "stylers": [
            { "visibility": "off" }
          ]
        },{
          "featureType": "poi.government",
          "elementType": "labels",
          "stylers": [
            { "visibility": "off" }
          ]
        }
      ];

      map.setOptions({
        styles: styles,
        streetViewControl: true});
      google.maps.event.trigger(map, 'resize');

    </script>
    {% endblock %}
  </body>
</html>
